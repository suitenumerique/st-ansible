---
name: messages
services:
{% if st_messages_mpa_auth_bearer is defined and st_messages_mpa_auth_bearer | length > 0 %}
  nginx:
    container_name: nginx
    image: docker.io/nginx:1-alpine
    network_mode: host
    volumes:
      - {{ st_messages_mpa_dir }}/nginx_config/nginx.conf:/etc/nginx/conf.d/default.conf
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:50090/healthcheck"]
      interval: 1m
      timeout: 3s
      start_period: 10s
{% endif %}
  rspamd:
    container_name: rspamd
    image: docker.io/rspamd/rspamd:{{ st_messages_mpa_rspamd_tag }}
    network_mode: host
    depends_on:
      - clamav
      - unbound
      {{ '- valkey' if st_messages_mpa_valkey_enabled }}
    volumes:
      - rspamd_data:/var/lib/rspamd
      - {{ st_messages_mpa_dir }}/rspamd_config:/etc/rspamd
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'exec 3<>/dev/tcp/localhost/11334; printf \"GET /ping HTTP/1.1\r\nHost: localhost\r\nConnection: close\r\n\r\n\" >&3; grep \"pong\" <&3'"]
      interval: 1m
      timeout: 3s
      start_period: 10s

  clamav:
    container_name: clamav
    image: docker.io/clamav/clamav:{{ st_messages_mpa_clamav_tag }}
    network_mode: host
    volumes:
      - {{ st_messages_mpa_dir }}/clamav_config/clamd.conf:/etc/clamav/clamd.conf
    healthcheck:
      test: ["CMD", "clamdscan", "--ping", "1"]
      interval: 1m
      timeout: 3s
      start_period: 10s

  unbound:
    container_name: unbound
    image: docker.io/alpinelinux/unbound:latest
    network_mode: host
    entrypoint:
      - /bin/sh
      - -c
      - |
          unbound-anchor -a /etc/unbound/root.key
          exec unbound -dp
    volumes:
      - {{ st_messages_mpa_dir }}/unbound_config/unbound.conf:/etc/unbound/unbound.conf
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "5353"]
      interval: 10s
      timeout: 3s

{% if st_messages_mpa_valkey_enabled %}
  valkey:
    container_name: valkey
    image: docker.io/valkey/valkey:{{ st_messages_mpa_valkey_tag }}
    network_mode: host
    command: "valkey-server --save 60 1 --loglevel warning"
    volumes:
      - valkey_data:/data
{% endif %}

volumes:
  rspamd_data:
{% if st_messages_mpa_valkey_enabled %}
  valkey_data:
{% endif %}
